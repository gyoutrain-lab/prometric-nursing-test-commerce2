<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Nursing Unlock</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f4f4f4; }
h2 { text-align:center; }
table { width:100%; border-collapse:collapse; background:#fff; }
th, td { padding:10px; text-align:center; border:1px solid #ccc; }
th { background:#007bff; color:#fff; }
tr.pending { background:#fff3cd; }      /* yellow */
tr.confirmed { background:#d4edda; }    /* green */
tr.used { background:#f8d7da; }         /* red */
button { padding:5px 10px; border:none; border-radius:5px; cursor:pointer; }
button.approve { background:#28a745; color:#fff; }
button.used { background:#6c757d; color:#fff; }
</style>
</head>
<body>

<h2>Admin Dashboard - Nursing Unlock System</h2>
<table id="userTable">
<thead>
<tr>
<th>Row</th><th>Timestamp</th><th>Name</th><th>WA</th><th>Status</th><th>UnlockCode</th><th>CodeSent</th><th>Used</th><th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbzCT5qzso0hDEpyemfATUTyEQYouQtp98m8ogDBwTnpL41L0DREKJC1CUnZ1c1LJfTMlA/exec";

// Load users from Google Sheet
async function loadUsers(){
  try {
    const res = await fetch(GAS_URL,{
      method:"POST",
      body:JSON.stringify({admin:"getUsers"})
    });
    const data = await res.json();
    const tbody = document.querySelector("#userTable tbody");
    tbody.innerHTML="";
    data.forEach((row,i)=>{
      const tr = document.createElement("tr");

      // Add status class for color-coding
      let statusClass = row[3]==="Pending"?"pending": row[6]==="Yes"?"used":"confirmed";
      tr.className = statusClass;

      tr.innerHTML=`
        <td>${i+1}</td>
        <td>${row[0]}</td>
        <td>${row[1]}</td>
        <td>${row[2]}</td>
        <td>${row[3]}</td>
        <td>${row[4] ? "****" : ""}</td>
        <td>${row[5]}</td>
        <td>${row[6]}</td>
        <td>
          ${row[3]==="Pending"?`<button class="approve" onclick="approveUser(${i+1})">Send Unlock</button>`:
            row[6]!=="Yes"?`<button class="used" onclick="markUsed(${i+1})">Mark Used</button>`:"Done"}
        </td>`;
      tbody.appendChild(tr);
    });
  } catch(err){ console.log("Error loading users:",err);}
}

// Admin approves a user
function approveUser(row){
  const code = prompt("Enter unlock code for this user:");
  if(!code) return;
  fetch(GAS_URL,{
    method:"POST",
    body:JSON.stringify({action:"approve", row:row, unlockCode:code})
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="success"){ 
      alert("Unlock code sent to user!"); 
      loadUsers();
    } else alert("Error: "+data.message);
  });
}

// Admin marks code as used
function markUsed(row){
  fetch(GAS_URL,{
    method:"POST",
    body:JSON.stringify({action:"used", row:row})
  }).then(res=>res.json())
  .then(data=>{
    if(data.status==="success"){ 
      loadUsers(); 
    } else alert("Error: "+data.message);
  });
}

// Auto-refresh every 5 seconds
setInterval(loadUsers,5000);

// Initial load
loadUsers();
</script>

</body>
</html>

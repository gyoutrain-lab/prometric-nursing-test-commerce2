// ---------------------------------------------------
// SECURE FRONTEND-ONLY UNLOCK SYSTEM (ADMIN CONTROLLED)
// ---------------------------------------------------

// Generate unique session ID for each user
let sessionID = "SID-" + Math.random().toString(36).substring(2, 10).toUpperCase();

// Store session ID so refresh cannot reset it
if (!localStorage.getItem("unlock_sessionID")) {
  localStorage.setItem("unlock_sessionID", sessionID);
} else {
  sessionID = localStorage.getItem("unlock_sessionID");
}

// Track unlock state
let unlockAllowed = false;
let attempts = 0;
const MAX_ATTEMPTS = 3;

// Admin creates unlock codes (manual, private)
const VALID_CODES = ["GY500A", "GY500B", "GY500C"]; // You can change anytime

function confirmPayment() {
  const userName = document.getElementById("userNameInput").value.trim();
  const userWA = document.getElementById("userWAInput").value.trim();

  if (!userName || !userWA) {
    alert("Please fill in your Name and WA # before confirming payment.");
    return;
  }

  // Step 1: Inform user
  alert(
    "Admin will provide your unlock code.\nPlease send your payment proof first."
  );

  // Step 2: Ask user to send proof
  const action = confirm("Press OK to send payment proof.\nPress CANCEL to stop.");

  if (!action) {
    alert("Payment process canceled.");
    return;
  }

  // User chooses OK â†’ Send details to admin
  const adminMsg =
    `NEW PAYMENT REQUEST\n\n` +
    `Name: ${userName}\n` +
    `WA #: ${userWA}\n` +
    `Session ID: ${sessionID}\n\n` +
    `User requested unlock.\n` +
    `Send unlock code manually.\n` +
    `Press 1 to approve, 2 to deny.`;

  // WhatsApp notification
  window.open(
    `https://wa.me/6285399652487?text=${encodeURIComponent(adminMsg)}`,
    "_blank"
  );

  alert("Admin notified. Please wait for admin to give your unlock code.");
  unlockAllowed = true;
  document.getElementById("continue-btn").disabled = false;
}

function checkUnlockCode() {
  if (!unlockAllowed) {
    alert("You must send the payment proof first.");
    return;
  }

  const code = document
    .getElementById("unlockCodeInput")
    .value.trim()
    .toUpperCase();

  if (!code) {
    alert("Enter the unlock code.");
    return;
  }

  // Max attempts control
  attempts++;
  if (attempts > MAX_ATTEMPTS) {
    alert("Too many wrong attempts. Access blocked.");
    return;
  }

  // Validate against admin's codes
  if (VALID_CODES.includes(code)) {
    alert("Unlock successful! Redirecting...");
    localStorage.removeItem("unlock_sessionID"); // Clear session
    window.location.href =
      "https://gyoutrain-lab.github.io/nursing-prometric-test-allinone500/";
  } else {
    alert("Incorrect code. Attempts left: " + (MAX_ATTEMPTS - attempts));
  }
}

// ---------------------------------------------------
// SECURE FRONTEND-ONLY UNLOCK SYSTEM (ADMIN CONTROLLED)
// ---------------------------------------------------

// Wait for DOM to load (important for GitHub Pages)
document.addEventListener("DOMContentLoaded", () => {

  // Generate unique session ID for each user
  let sessionID = "SID-" + Math.random().toString(36).substring(2, 10).toUpperCase();

  // Prevent session reset on refresh
  if (!localStorage.getItem("unlock_sessionID")) {
    localStorage.setItem("unlock_sessionID", sessionID);
  } else {
    sessionID = localStorage.getItem("unlock_sessionID");
  }

  // Unlock state + attempt limit
  window.unlockAllowed = false; // make accessible globally
  window.attempts = 0;
  const MAX_ATTEMPTS = 3;

  // Admin-controlled unlock codes
  const VALID_CODES = ["GY500A", "GY500B", "GY500C"];

  // ---------------------------------------------------
  // CONFIRM PAYMENT PROCESS
  // ---------------------------------------------------
  window.confirmPayment = function () {
    const nameField = document.getElementById("userNameInput");
    const waField = document.getElementById("userWAInput");

    if (!nameField || !waField) {
      alert("ERROR: Required input fields not found in HTML.");
      return;
    }

    const userName = nameField.value.trim();
    const userWA = waField.value.trim();

    // Field check
    if (!userName || !userWA) {
      alert("Please fill in your Name and WA # before confirming payment.");
      return;
    }

    // WA validation
    const cleanedWA = userWA.replace(/[^0-9+]/g, "");
    if (!/^\+?\d{10,15}$/.test(cleanedWA)) {
      alert("Invalid WA number format.");
      return;
    }

    alert(
      "Admin will provide your unlock code.\nPlease send your payment proof first."
    );

    const action = confirm("Press OK to send payment proof.\nPress CANCEL to stop.");
    if (!action) {
      alert("Payment process canceled.");
      return;
    }

    const adminMsg =
      `NEW PAYMENT REQUEST\n\n` +
      `Name: ${userName}\n` +
      `WA #: ${cleanedWA}\n` +
      `Session ID: ${sessionID}\n\n` +
      `User requested unlock.\n` +
      `Send unlock code manually.\n` +
      `Press 1 to approve, 2 to deny.`;

    // Notify admin via WhatsApp
    window.open(
      `https://wa.me/6285399652487?text=${encodeURIComponent(adminMsg)}`,
      "_blank"
    );

    alert("Admin notified. Please wait for admin to give your unlock code.");

    window.unlockAllowed = true;

    const btn = document.getElementById("continue-btn");
    if (btn) btn.disabled = false;
  };

  // ---------------------------------------------------
  // CHECK UNLOCK CODE
  // ---------------------------------------------------
  window.checkUnlockCode = function () {
    if (!window.unlockAllowed) {
      alert("You must send the payment proof first.");
      return;
    }

    const codeField = document.getElementById("unlockCodeInput");
    if (!codeField) {
      alert("ERROR: Unlock code input field not found in HTML.");
      return;
    }

    const code = codeField.value.trim().toUpperCase();
    if (!code) {
      alert("Enter the unlock code.");
      return;
    }

    window.attempts++;
    if (window.attempts > MAX_ATTEMPTS) {
      alert("Too many wrong attempts. Access blocked.");
      return;
    }

    if (VALID_CODES.includes(code)) {
      alert("Unlock successful! Redirecting...");

      localStorage.removeItem("unlock_sessionID");

      window.location.href =
        "https://gyoutrain-lab.github.io/nursing-prometric-test-allinone500/";
    } else {
      alert("Incorrect code. Attempts left: " + (MAX_ATTEMPTS - window.attempts));
    }
  };

});

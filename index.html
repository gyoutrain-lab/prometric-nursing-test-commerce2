// -----------------------------------------------------
// SECURITY LEVEL 2 — ADVANCED FRONTEND PROTECTION
// -----------------------------------------------------

// ----------- ENCRYPTED SESSION TOKEN -----------
function encryptSession(str) {
  return btoa(unescape(encodeURIComponent(str)));
}

let sessionID = "SID-" + Math.random().toString(36).substring(2, 12).toUpperCase();
let encryptedSession = encryptSession(sessionID);

// Prevent refresh bypass
if (!localStorage.getItem("secure_session")) {
  localStorage.setItem("secure_session", encryptedSession);
} else {
  encryptedSession = localStorage.getItem("secure_session");
}

// ----------- UNLOCK SYSTEM CONTROL -----------
let unlockAllowed = false;
let attempts = 0;
const MAX_ATTEMPTS = 3;

// Admin-managed One-Time Codes
let VALID_CODES = {
  "GY500A": null,
  "GY500B": null,
  "GY500C": null
};

// Code expires in 10 minutes
const EXPIRATION_MS = 10 * 60 * 1000;

function setCodeTimer(code) {
  VALID_CODES[code] = Date.now() + EXPIRATION_MS;
}

function isCodeExpired(code) {
  if (!VALID_CODES[code]) return true;
  return Date.now() > VALID_CODES[code];
}

// ----------- LOCKOUT HANDLING -----------
function lockedOut() {
  const lockUntil = Date.now() + 5 * 60 * 1000; // 5 minutes
  localStorage.setItem("lockout_until", lockUntil);
}

function isLocked() {
  const until = localStorage.getItem("lockout_until");
  if (!until) return false;
  return Date.now() < parseInt(until);
}

// ------------------------------------------------
// PAYMENT CONFIRMATION → ADMIN NOTIFICATION
// ------------------------------------------------
function confirmPayment() {
  const userName = document.getElementById("userNameInput").value.trim();
  const userWA = document.getElementById("userWAInput").value.trim();

  if (!userName || !userWA) {
    alert("Please fill in your Name and WA # before confirming payment.");
    return;
  }

  // Locked?
  if (isLocked()) {
    alert("Too many attempts. Try again later.");
    return;
  }

  alert(
    "Admin will provide your unlock code.\nYou must send the payment proof first."
  );

  const action = confirm(
    "Press OK to send payment proof.\nPress CANCEL to stop."
  );

  if (!action) {
    alert("Payment process canceled.");
    return;
  }

  // WhatsApp Notification
  const adminMsg =
    `NEW PAYMENT REQUEST\n\n` +
    `Name: ${userName}\n` +
    `WA #: ${userWA}\n` +
    `Session: ${encryptedSession}\n\n` +
    `Send UNLOCK CODE manually.\n` +
    `Press 1 to approve (issue code)\nPress 2 to deny.`;

  window.open(
    `https://wa.me/6285399652487?text=${encodeURIComponent(adminMsg)}`,
    "_blank"
  );

  alert("Admin notified. Please wait for admin to provide unlock code.");

  unlockAllowed = true;
  const btn = document.getElementById("continue-btn");
  if (btn) btn.disabled = false;
}

// ------------------------------------------------
// VERIFY UNLOCK CODE
// ------------------------------------------------
function checkUnlockCode() {
  if (!unlockAllowed) {
    alert("You must send payment proof first.");
    return;
  }

  if (isLocked()) {
    alert("Too many attempts. Try again later.");
    return;
  }

  const code = document.getElementById("unlockCodeInput").value.trim().toUpperCase();

  if (!code) {
    alert("Enter the unlock code first.");
    return;
  }

  attempts++;

  // Not a valid code in dictionary
  if (!VALID_CODES.hasOwnProperty(code)) {
    alert("Invalid unlock code.");
    punishment();
    return;
  }

  // First time → activate expiration
  if (VALID_CODES[code] === null) {
    setCodeTimer(code);
  }

  // Expired?
  if (isCodeExpired(code)) {
    alert("This unlock code has expired. Request a new one.");
    punishment();
    return;
  }

  // SUCCESS
  alert("Unlock successful! Redirecting...");

  // Burn code
  delete VALID_CODES[code];

  // Clear session
  localStorage.removeItem("secure_session");
  localStorage.removeItem("lockout_until");

  window.location.href = "https://gyoutrain-lab.github.io/nursing-prometric-test-allinone500/";
}

// ------------------------------------------------
// WRONG ATTEMPTS HANDLER
// ------------------------------------------------
function punishment() {
  if (attempts >= MAX_ATTEMPTS) {
    alert("Too many wrong attempts. Locked for 5 minutes.");
    lockedOut();
  } else {
    alert(`Wrong code. Attempts left: ${MAX_ATTEMPTS - attempts}`);
  }
}
